{"version":3,"sources":["../src/browser/app/main/game/game.component.ts"],"names":[],"mappings":"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","file":"game.component.js","sourcesContent":["import {\n    Component, Input, Inject, NgZone, OnInit, AfterViewInit, Pipe, PipeTransform, Output,\n    EventEmitter\n} from '@angular/core';\nimport {Tab} from './../tab/tab';\nimport {ShortCuts} from './../../shortcuts/shortcuts';\nimport * as async from 'async';\nimport {IpcRendererService} from './../../../shared/electron/ipcrenderer.service';\nimport {SettingsService} from './../../../shared/settings/settings.service';\nimport {ApplicationService} from \"./../../../shared/electron/application.service\";\nimport {DomSanitizer, SafeUrl, Title} from \"@angular/platform-browser\";\n\nconst {remote} = (<any>global).nodeRequire('electron');\n\n@Pipe({name: 'safe'})\nexport class SafePipe implements PipeTransform {\n    constructor(private sanitizer: DomSanitizer) {\n    }\n\n    transform(url: string) {\n        return this.sanitizer.bypassSecurityTrustResourceUrl(url);\n    }\n}\n\n@Component({\n    selector: 'game',\n    templateUrl: 'app/main/game/game.component.html',\n    styleUrls: ['app/main/game/game.component.css']\n})\nexport class GameComponent implements OnInit, AfterViewInit {\n\n    @Input() private tab: Tab;\n    @Output() selectTab = new EventEmitter();\n    private shortCuts: ShortCuts;\n    private gamePath: string;\n    private gameLoaded: boolean = false;\n\n    constructor(@Inject('Window') private window: Window,\n                private ipcRendererService: IpcRendererService,\n                private zone: NgZone,\n                private settingsService: SettingsService,\n                private applicationService: ApplicationService,\n                private titleService: Title) {\n        this.gamePath = this.applicationService.gamePath + '/index.html';\n    }\n\n    ngOnInit() {\n\n    }\n\n    ngAfterViewInit() {\n        // after View Init get the iFrame\n        this.tab.window = this.window['Frame' + this.tab.id].contentWindow;\n\n        this.shortCuts = new ShortCuts(this.tab.window);\n    }\n\n    private gameReady(): void {\n\n        if (this.gameLoaded) {\n            this.setEventListener();\n        }\n\n        this.gameLoaded = true;\n    }\n\n    private setEventListener(): void {\n\n        // event -> resize window game\n        this.tab.window.onresize = () => {\n            (<any>this.tab.window).gui._resizeUi();\n        };\n\n\n        // event -> log into the world\n        (<any>this.tab.window).gui.playerData.on(\"characterSelectedSuccess\", () => {\n\n            // retrieve character name and update zone.js\n            this.zone.run(() => {\n                this.tab.character = (<any>this.tab.window).gui.playerData.characterBaseInformations.name;\n                this.tab.isLogged = true;\n                this.titleService.setTitle(this.tab.character);\n            });\n\n            // bind event IG\n            this.bindEventIG();\n\n            // bind shortcut\n            this.bindShortcuts();\n        });\n\n        (<any>this.tab.window).gui.on(\"disconnect\", () => {\n            this.unBindEventIG();\n            //this.\n            this.zone.run(() => {\n                this.tab.isLogged = false;\n                this.tab.character = null;\n            });\n        });\n\n        // event -> electron ask for reload setting\n        this.ipcRendererService.on('reload-shortcuts', (event: any, arg: any) => {\n            if (this.tab.isLogged) {\n                console.log('receive->reload-shortcuts');\n\n                // unbind all registered shortcuts\n                this.unBindShortcuts();\n\n                // re-bind new shortcuts\n                this.bindShortcuts();\n            }\n        });\n    }\n\n    private sendMPNotif(msg: any) {\n        if (!this.tab.window.document.hasFocus() && this.settingsService.option.notification.private_message) {\n            if (msg.channel == 9) {\n\n                this.zone.run(() => {\n                    this.tab.notification = true;\n                });\n\n                let mpNotif = new Notification('Message de : ' + msg.senderName, {\n                    body: msg.content\n                });\n\n                mpNotif.onclick = () => {\n                    remote.getCurrentWindow().focus();\n                    this.zone.run(() => {\n                        this.selectTab.emit(this.tab);\n                    });\n                };\n\n\n            }\n        }\n    }\n\n    private sendFightTurnNotif(actor: any) {\n        if (!this.tab.window.document.hasFocus()\n            && this.settingsService.option.notification.fight_turn\n            && (<any>this.tab.window).gui.playerData.characterBaseInformations.id == actor.id) {\n\n\n            this.zone.run(() => {\n                this.tab.notification = true;\n            });\n\n            let turnNotif = new Notification('Début du tour de ' + (<any>this.tab.window).gui.playerData.characterBaseInformations.name);\n\n            turnNotif.onclick = () => {\n                remote.getCurrentWindow().focus();\n                this.zone.run(() => {\n                    this.selectTab.emit(this.tab);\n                });\n            };\n        }\n    }\n\n    private bindEventIG(): void {\n\n        (<any>this.tab.window).dofus.connectionManager.on('ChatServerMessage', (msg: any) => {\n            this.sendMPNotif(msg);\n        });\n        (<any>this.tab.window).gui.eventHandlers.GameFightTurnStartMessage.push((actor: any) => {\n            this.sendFightTurnNotif(actor);\n        });\n        /*(<any>this.tab.window).gui.on('GameFightTurnStartMessage', (actor: any) => {\n         this.sendFightTurnNotif(actor)\n         });*/\n\n\n    }\n\n    private unBindEventIG(): void {\n        (<any>this.tab.window).dofus.connectionManager.removeListener('ChatServerMessage', (msg: any) => {\n            this.sendMPNotif(msg);\n        });\n        //(<any>this.tab.window).gui.removeListener('GameFightTurnStartMessage', this.sendFightTurnNotif);\n        (<any>this.tab.window).gui.eventHandlers.GameFightTurnStartMessage.splice(\n            (<any>this.tab.window).gui.eventHandlers.GameFightTurnStartMessage.indexOf((actor: any) => {\n                this.sendFightTurnNotif(actor);\n            }),\n            1\n        );\n    }\n\n    private unBindShortcuts(): void {\n        this.shortCuts.unBindAll();\n    }\n\n    private bindShortcuts(): void {\n\n        // end turn\n        this.shortCuts.bind(this.settingsService.option.shortcuts.diver.end_turn, () => {\n            (<any>this.tab.window).gui.fightManager.finishTurn()\n        });\n\n        // spell\n        async.forEachOf(this.settingsService.option.shortcuts.spell, (shortcut: string, index: number) => {\n            this.shortCuts.bind(shortcut, () => {\n                (<any>this.tab.window).gui.shortcutBar._panels.spell.slotList[index].tap();\n                //(<any>this.tab.window).gui.shortcutBar.panels.spell.slotList[index].tap();\n            });\n        });\n\n        // item\n        async.forEachOf(this.settingsService.option.shortcuts.item, (shortcut: string, index: number) => {\n            this.shortCuts.bind(shortcut, () => {\n                //(<any>this.tab.window).gui.shortcutBar.panels.item.slotList[index].tap();\n                (<any>this.tab.window).gui.shortcutBar._panels.item.slotList[index].tap();\n            });\n        });\n\n        // interfaces\n        async.forEachOf(this.settingsService.option.shortcuts.interface.getAll(), (inter: any) => {\n            (<any>this.tab.window).gui.menuBar._icons._childrenList.forEach((element: any, index: number) => {\n                if (element.id.toUpperCase() == inter.key.toUpperCase()) {\n                    this.shortCuts.bind(inter.value, () => {\n                        let newIndex = index;\n                        (<any>this.tab.window).gui.menuBar._icons._childrenList[newIndex].tap();\n                    });\n                    return;\n                }\n            });\n        });\n    }\n}\n"]}